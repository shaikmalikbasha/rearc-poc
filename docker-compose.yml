version: '3.9'

services:
  bls-app:
    build: ./bls-app
    container_name: bls-app
    ports:
      - "5000:5000"
    environment:
      - MINIO_ENDPOINT=minio-service:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    depends_on:
      - minio-service

  s3-webhook:
    build: ./s3-webhook
    container_name: s3-webhook
    ports:
      - "8000:8000"
    environment:
      - MINIO_ENDPOINT=minio-service:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    depends_on:
      - minio-service

  # --- New Lambda Service ---
  lambda-api:
    build: ./lambda-api
    container_name: lambda-api
    ports:
      - "8080:8080"
    environment:
      - BASE_URL=http://bls-app:5000
      - MINIO_ENDPOINT=http://minio-service:9000
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - AWS_REGION=us-east-1
    volumes:
    - ./lambda-api:/var/task
    depends_on:
      - minio-service

  minio-service:
    image: minio/minio
    container_name: minio-service
    ports:
      - "9005:9000"
      - "9006:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      # --- Webhook Updates ---
      MINIO_NOTIFY_WEBHOOK_ENABLE_primary: "on"
      # Points to your FastAPI app on port 8000 inside the docker network
      MINIO_NOTIFY_WEBHOOK_ENDPOINT_primary: "http://s3-webhook:8000/minio-webhook"
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data

  minio-init:
    image: minio/mc
    depends_on:
      - minio-service
    entrypoint: 
      - /bin/sh
      - -c
      - |
        echo 'Initializing MinIO...'
        
        # 1. Setup Alias
        # We use a simple loop without complex semicolons
        until /usr/bin/mc alias set myminio http://minio-service:9000 minioadmin minioadmin; do
          echo 'Waiting for MinIO API...'
          sleep 5
        done

        # 2. Create Bucket
        /usr/bin/mc mb --ignore-existing myminio/my-bucket

        # 3. Clear existing notifications to avoid overlap errors
        echo 'Clearing existing bucket notifications...'
        /usr/bin/mc event remove myminio/my-bucket --force || echo 'No events to remove.'

        # 4. Register Webhook with a check
        echo 'Attempting to register webhook event...'
        
        while true; do
          # Check if already registered
          if /usr/bin/mc event list myminio/my-bucket | grep -q 'primary:webhook'; then
            echo 'Webhook already registered!'
            break
          fi

          # Attempt to add
          if /usr/bin/mc event add myminio/my-bucket arn:minio:sqs::primary:webhook --event put; then
            echo 'Webhook successfully registered!'
            break
          else
            echo 'ARN not ready or overlap detected, retrying in 3s...'
            sleep 3
          fi
        done
        echo 'MinIO Initialization Complete.'

volumes:
  minio-data:
