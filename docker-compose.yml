version: '3.9'

services:
  bls-app:
    build: ./bls-app
    container_name: bls-app
    ports:
      - "5000:5000"
    environment:
      - MINIO_ENDPOINT=minio-service:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    depends_on:
      - minio-service

  s3-webhook:
    build: ./s3-webhook
    container_name: s3-webhook
    ports:
      - "8000:8000"
    environment:
      - MINIO_ENDPOINT=minio-service:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    depends_on:
      - minio-service

  # --- New Lambda Service ---
  lambda-api:
    build: ./lambda-api
    container_name: lambda-api
    ports:
      - "8080:8080"
    environment:
      - BASE_URL=http://bls-app:5000
      - MINIO_ENDPOINT=http://minio-service:9000
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - AWS_REGION=us-east-1
    volumes:
    - ./lambda-api:/var/task
    depends_on:
      - minio-service

  minio-service:
    image: minio/minio
    container_name: minio-service
    ports:
      - "9005:9000"
      - "9006:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      # --- Webhook Updates ---
      MINIO_NOTIFY_WEBHOOK_ENABLE_primary: "on"
      # Points to your FastAPI app on port 8000 inside the docker network
      MINIO_NOTIFY_WEBHOOK_ENDPOINT_primary: "http://s3-webhook:8000/minio-webhook"
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data

  minio-init:
    image: minio/mc
    depends_on:
      - minio-service
    entrypoint: >
      /bin/sh -c "
      echo 'Initializing MinIO...';
      while ! /usr/bin/mc alias set myminio http://minio-service:9000 minioadmin minioadmin; do
        echo 'Waiting for MinIO API...';
        sleep 2;
      done;

      /usr/bin/mc mb --ignore-existing myminio/my-bucket;

      echo 'Attempting to register webhook event...';
      while ! /usr/bin/mc event add myminio/my-bucket arn:minio:sqs::primary:webhook --event put; do
        echo 'ARN not ready yet, retrying...';
        sleep 3;
      done;

      echo 'Webhook successfully registered!';
      "

volumes:
  minio-data:
